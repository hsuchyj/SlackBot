{"version":3,"sources":["../src/storage/MongoDbAADObjectIdStorage.ts"],"names":[],"mappings":"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","file":"MongoDbAADObjectIdStorage.js","sourcesContent":["// import * as assert from \"assert\";\nimport * as mongodb from \"mongodb\";\n// import { IBotChannelStorageContext, IBotChannelStorageData, IBotChannelStorage } from \"./BotChannelStorage\";\nimport * as config from \"config\";\n\n// tslint:disable-next-line:variable-name\nexport interface AADObjectIdEntry {\n    _id?: string;\n    aadObjectId: string;\n    vstsToken: string;\n    vstsRefreshToken: string;\n};\n\nexport class MongoDbAADObjectIdStorage {\n\n    // private initializePromise: Promise<void>;\n    private mongoDb: mongodb.Db;\n    private botStateCollection: mongodb.Collection;\n\n    public static async createConnection(): Promise<MongoDbAADObjectIdStorage> {\n        let collectionName = config.get(\"mongoDb.botStateCollection\");\n        let connectionString = config.get(\"mongoDb.connectionString\");\n        let resultMongoDbAADObjectIdStorage = new MongoDbAADObjectIdStorage(collectionName, connectionString);\n        await resultMongoDbAADObjectIdStorage.initialize();\n        return resultMongoDbAADObjectIdStorage;\n    }\n\n    constructor(\n        private collectionName: string,\n        private connectionString: string) {\n    }\n\n    // Reads in data from storage\n    public async getEntryByAADObjectId(aadObjectId: string): Promise<any> {\n        // if (context.channelId) {\n            // await this.initialize();\n            if (!this.botStateCollection) {\n                return ({} as any);\n            }\n\n            // let filter = { \"_id\": _id };\n            let filter = { \"aadObjectId\": aadObjectId };\n            let entry = await this.botStateCollection.findOne(filter);\n            // await this.close();\n            if (entry) {\n                return entry;\n            } else {\n                return ({} as any);\n            }\n        // } else {\n        //     return { };\n        // }\n    }\n\n    // Writes out data from storage\n    public async saveTokensByAADObjectId(entry: AADObjectIdEntry): Promise<void> {\n        // if (context.teamId && context.channelId && data.channelData) {\n            // await this.initialize();\n            if (!this.botStateCollection) {\n                return;\n            }\n\n            let filter = { \"_id\": \"aadObjectId:\" + entry.aadObjectId };\n            entry._id = \"aadObjectId:\" + entry.aadObjectId;\n            // let document = {\n            //     teamId: context.teamId,\n            //     channelId: context.channelId,\n            //     data: data.channelData,\n            // };\n            // let document = {\n            //     token: tokens.token,\n            //     refreshToken: tokens.refreshToken,\n            // };\n            await this.botStateCollection.updateOne(filter, entry, { upsert: true });\n            // await this.close();\n        // }\n    }\n\n    // Writes out data from storage\n    public async saveBotEntry(entry: any): Promise<void> {\n        // if (context.teamId && context.channelId && data.channelData) {\n            // await this.initialize();\n            if (!this.botStateCollection) {\n                return;\n            }\n\n            let filter = { \"_id\": entry._id };\n            // let document = {\n            //     teamId: context.teamId,\n            //     channelId: context.channelId,\n            //     data: data.channelData,\n            // };\n            // let document = {\n            //     token: tokens.token,\n            //     refreshToken: tokens.refreshToken,\n            // };\n            await this.botStateCollection.updateOne(filter, entry, { upsert: true });\n            // await this.close();\n        // }\n    }\n\n    // Writes out data from storage\n    public async deleteEntryByAADObjectId(aadObjectId: string): Promise<void> {\n        // if (context.teamId && context.channelId && data.channelData) {\n            // await this.initialize();\n            if (!this.botStateCollection) {\n                return;\n            }\n\n            let filter = { \"_id\": \"aadObjectId:\" + aadObjectId };\n            // let document = {\n            //     teamId: context.teamId,\n            //     channelId: context.channelId,\n            //     data: data.channelData,\n            // };\n            // let document = {\n            //     token: tokens.token,\n            //     refreshToken: tokens.refreshToken,\n            // };\n            await this.botStateCollection.deleteMany(filter);\n            // await this.close();\n        // }\n    }\n\n    // Close the connection to the database\n    public async close(): Promise<void> {\n        // this.initializePromise = null;\n        this.botStateCollection = null;\n        if (this.mongoDb) {\n            await this.mongoDb.close();\n            this.mongoDb = null;\n        }\n    }\n\n    // Returns a promise that is resolved when this instance is initialized\n    // private initialize(): Promise<void> {\n    //     if (!this.initializePromise) {\n    //         this.initializePromise = this.initializeWorker();\n    //     }\n    //     return this.initializePromise;\n    // }\n\n    // Initialize this instance\n    private async initialize(): Promise<void> {\n        if (!this.mongoDb) {\n            try {\n                this.mongoDb = await mongodb.MongoClient.connect(this.connectionString);\n                this.botStateCollection = await this.mongoDb.collection(this.collectionName);\n            } catch (e) {\n                // console.log(e.toString());\n                await this.close();\n                // this.initializePromise = null;\n            }\n        }\n    }\n\n    // // Get id for channel data documents\n    // private getChannelDataId(context: IBotChannelStorageContext): string {\n    //     assert(context.channelId);\n    //     return `channel:${context.channelId}`;\n    // }\n}\n"],"sourceRoot":"/app/build"}